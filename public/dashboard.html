<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Amigo Oculto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Mesmo estilo do index.html */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 21px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .event-list {
            margin-top: 20px;
        }
        .event-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .user-info {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .user-email {
            color: #666;
            font-size: 0.9em;
        }
        .user-name {
            font-weight: bold;
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logout-btn {
            background-color: #dc3545;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        /* Adicione estes estilos */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: slideDown 0.3s ease-out;
        }
        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px;
            z-index: 1;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .dashboard-content {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .main-content {
            flex-grow: 1;
        }

        .notifications-panel, .friends-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .notifications-list, .friends-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #fff;
            transition: background-color 0.3s;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-content {
            flex: 1;
            cursor: pointer;
            padding-right: 10px;
        }

        .notification-actions {
            display: flex;
            gap: 5px;
        }

        .accept-btn, .reject-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .accept-btn {
            background-color: #28a745;
            color: white;
        }

        .reject-btn {
            background-color: #dc3545;
            color: white;
        }

        .accept-btn:hover {
            background-color: #218838;
        }

        .reject-btn:hover {
            background-color: #c82333;
        }

        .notification-item.unread {
            background-color: #f0f8ff;
        }

        .friend-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .add-friend-btn {
            width: 100%;
            margin-bottom: 10px;
        }

        .notification-item {
            position: relative;
        }

        .notification-item .notification-content {
            display: inline-block;
        }

        .notification-item .notification-actions {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .friends-list-complete {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .friend-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .friend-card .friend-info {
            margin-bottom: 10px;
        }

        .friend-card .friend-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .friend-card .friend-email {
            color: #666;
            font-size: 0.9em;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .info-text {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            color: #666;
        }

        .secondary-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .secondary-btn:hover {
            background-color: #5a6268;
        }

        .delete-btn {
            background-color: transparent;
            border: none;
            color: #dc3545;
            padding: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: color 0.3s;
        }

        .delete-btn:hover {
            color: #c82333;
        }

        .notification-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .friend-requests-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .friend-request-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-info {
            flex: 1;
        }

        .request-actions {
            display: flex;
            gap: 5px;
        }

        .friend-requests-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Estilo para o modal de criação de evento especificamente */
        #createEventModal .modal-content {
            margin: 2% auto;
            position: relative;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .friends-selection {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #fff;
        }

        .friend-select-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .friend-select-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .friend-select-item:hover {
            background-color: #f8f9fa;
        }

        .friend-select-item label {
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
            padding: 5px;
        }

        .friend-select-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .friend-info {
            flex: 1;
            margin-left: 10px;
        }

        .friend-info strong {
            display: block;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 3px;
        }

        .friend-info .friend-email {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }

        .form-group label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .events-list {
            margin-top: 20px;
        }
        
        .event-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .event-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .event-item p {
            margin: 5px 0;
            color: #666;
        }

        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            padding: 10px 20px;
            font-size: 1em;
        }

        .event-invite {
            background-color: #f8f9fa;
            border-left: 4px solid #17a2b8;
        }

        .event-invite .request-info strong {
            color: #17a2b8;
        }

        .warning-text {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .event-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .details-btn {
            background-color: #17a2b8;
        }

        .details-btn:hover {
            background-color: #138496;
        }

        .draw-btn {
            background-color: #28a745;
        }

        .draw-btn:hover {
            background-color: #218838;
        }

        .invite-btn {
            background-color: #ffc107;
            color: #000;
        }

        .invite-btn:hover {
            background-color: #e0a800;
        }

        .event-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .invite-modal .modal-content {
            max-width: 500px;
            padding: 25px;
        }

        .invite-modal h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .no-friends-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .event-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .participant-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .participant-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .participant-info {
            font-size: 0.9em;
            color: #666;
        }

        /* Estilos específicos para o modal de amigo sorteado */
        .friend-reveal {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        .friend-reveal h3 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .friend-reveal .friend-info {
            font-size: 1.2em;
            margin: 10px 0;
        }

        .friend-reveal .event-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1.1em;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .delete-btn i {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Meus Amigos Ocultos</h1>
            <div class="user-info">
                <span id="userName"></span>
                <span id="userEmail"></span>
                <button onclick="clearAllData()" class="danger-btn">Limpar Dados</button>
                <button onclick="logout()" class="logout-btn">Sair</button>
            </div>
        </div>
        <div class="dashboard-content">
            <div class="sidebar">
                <div class="friend-requests-panel">
                    <h3>Solicitações de Amizade</h3>
                    <div id="friend-requests-list" class="friend-requests-list">
                        <!-- Lista será carregada dinamicamente -->
                    </div>
                </div>
                <div class="friends-panel">
                    <h3>Amigos</h3>
                    <button onclick="showAddFriendModal()" class="add-friend-btn">Adicionar Amigo</button>
                    <div id="friends-list" class="friends-list">
                        <!-- Lista de amigos será carregada aqui -->
                    </div>
                </div>
            </div>
            <div class="main-content">
                <div class="action-buttons">
                    <button onclick="openCreateEventModal()">Criar Novo Amigo Oculto</button>
                    <button onclick="openFriendsListModal()">Ver Lista de Amigos</button>
                </div>
                <h2>Meus Amigos Ocultos</h2>
                <div id="events-list" class="events-list">
                    <!-- Lista de eventos será carregada aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criar novo amigo oculto -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Criar Novo Amigo Oculto</h2>
            <form id="createEventForm" onsubmit="handleCreateEvent(event)">
                <div class="form-group">
                    <label for="eventName">Nome do Evento:</label>
                    <input type="text" id="eventName" required>
                </div>
                <div class="form-group">
                    <label for="eventDate">Data:</label>
                    <input type="date" id="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventBudget">Valor Máximo:</label>
                    <input type="number" id="eventBudget" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Selecione pelo menos 2 amigos para convidar:</label>
                    <div id="friendsSelection" class="friends-selection">
                        <!-- Lista de amigos será carregada aqui -->
                    </div>
                </div>
                <button type="submit">Criar</button>
            </form>
        </div>
    </div>

    <!-- Adicione este modal após o modal existente -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddFriendModal()">&times;</span>
            <h2>Adicionar Amigo</h2>
            <form id="addFriendForm" onsubmit="handleAddFriend(event)">
                <div class="form-group">
                    <label for="friendEmail">Email do Amigo:</label>
                    <input type="email" id="friendEmail" required>
                </div>
                <button type="submit">Enviar Solicitação</button>
            </form>
        </div>
    </div>

    <!-- Adicione este novo modal para lista de amigos -->
    <div id="friendsListModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFriendsListModal()">&times;</span>
            <h2>Meus Amigos</h2>
            <button onclick="showAddFriendModal()" class="add-friend-btn">Adicionar Novo Amigo</button>
            <div id="friendsListComplete" class="friends-list-complete">
                <!-- Lista completa de amigos será carregada aqui -->
            </div>
        </div>
    </div>

    <!-- Adicione este modal após os outros modais existentes -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInviteModal()">&times;</span>
            <h2>Convidar Participantes</h2>
            <div class="friends-selection" id="inviteFriendsSelection">
                <!-- Lista de amigos será carregada aqui -->
            </div>
            <button onclick="sendInvites()" class="invite-btn">Enviar Convites</button>
        </div>
    </div>

    <!-- Modal para detalhes do evento -->
    <div id="eventDetailsModal" class="modal event-details-modal">
        <div class="modal-content">
            <span class="close" onclick="closeEventDetailsModal()">&times;</span>
            <h2>Detalhes do Amigo Oculto</h2>
            <div id="eventDetailsContent">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para amigo sorteado -->
    <div id="drawnFriendModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDrawnFriendModal()">&times;</span>
            <div class="friend-reveal">
                <h3>🎁 Seu Amigo Secreto 🎁</h3>
                <div id="drawnFriendContent">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';

        // Adicione tratamento de erro global
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Erro não tratado:', event.reason);
            alert('Ocorreu um erro inesperado. Por favor, tente novamente.');
        });

        // Melhore a verificação de autenticação
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            if (!token || !userData.id) {
                console.log('Usuário não autenticado, redirecionando...');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // Adicione verificação de erro nas requisições
        async function fetchWithAuth(url, options = {}) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro na requisição');
                }

                return response;
            } catch (error) {
                console.error('Erro na requisição:', error);
                throw error;
            }
        }

        // Carrega os dados do usuário ao iniciar
        async function loadUserData() {
            try {
                const rawUserData = localStorage.getItem('userData');
                if (!rawUserData) {
                    console.error('Dados do usuário não encontrados');
                    window.location.href = '/';
                    return;
                }

                const userData = JSON.parse(rawUserData);
                console.log('=== DEBUG DADOS DO USUÁRIO ===', {
                    completo: userData,
                    id: userData?.id,
                    email: userData?.email,
                    nome: userData?.name
                });

                if (!userData?.id || !userData?.email || !userData?.name) {
                    console.error('Dados do usuário incompletos:', userData);
                    window.location.href = '/';
                    return;
                }

                document.getElementById('userName').textContent = `Olá, ${userData.name}!`;
                document.getElementById('userEmail').textContent = userData.email;
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                window.location.href = '/';
            }
        }

        async function loadEvents() {
            try {
                // Verifica se o usuário está autenticado e tem dados completos
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (!userData?.id || !userData?.email) {
                    console.error('Dados do usuário incompletos ou ausentes:', userData);
                    throw new Error('Usuário não autenticado ou dados incompletos');
                }

                console.log('=== DEBUG DADOS DO USUÁRIO ===', {
                    id: userData.id,
                    email: userData.email,
                    name: userData.name
                });

                const response = await fetch(`${API_URL}/secret-santa`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar eventos');

                const events = await response.json();
                console.log('Eventos carregados:', events);

                const eventsList = document.getElementById('events-list');
                if (!events || events.length === 0) {
                    eventsList.innerHTML = '<p>Nenhum evento encontrado.</p>';
                    return;
                }

                eventsList.innerHTML = events.map(event => {
                    const isDrawn = event.participants.some(p => p.targetUserId !== null);
                    const isOrganizer = event.organizerId === userData.id;

                    console.log(`=== DEBUG EVENTO ${event.name} ===`, {
                        evento: {
                            id: event.id,
                            organizadorId: event.organizerId
                        },
                        usuario: {
                            id: userData.id,
                            email: userData.email
                        },
                        verificacao: {
                            isOrganizer,
                            isDrawn,
                            participantes: event.participants.length
                        }
                    });

                    const hasEnoughParticipants = event.participants.length >= 3;

                    return `
                        <div class="event-item">
                            <div class="event-header">
                                <h3>${event.name}</h3>
                                ${isOrganizer ? `
                                    <button onclick="deleteEvent('${event.id}')" class="delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <p>Data: ${new Date(event.date).toLocaleDateString()}</p>
                            <p>Valor Máximo: R$ ${Number(event.budget).toFixed(2)}</p>
                            <p>Participantes: ${event.participants.length}</p>
                            <div class="event-actions">
                                ${!hasEnoughParticipants ? `
                                    <p class="warning-text">É necessário pelo menos 3 participantes</p>
                                    <button onclick="showInviteModal('${event.id}')" class="invite-btn">
                                        Convidar Participantes
                                    </button>
                                ` : isDrawn ? `
                                    <button onclick="showEventDetails('${event.id}')" class="details-btn">
                                        Ver Amigo Sorteado
                                    </button>
                                ` : isOrganizer ? `
                                    <button onclick="performDraw('${event.id}')" class="draw-btn">
                                        Realizar Sorteio
                                    </button>
                                ` : `
                                    <p class="warning-text">Aguardando o administrador realizar o sorteio</p>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                document.getElementById('events-list').innerHTML = '<p>Erro ao carregar eventos.</p>';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        // Inicialização
        checkAuth();
        loadUserData();
        loadEvents();

        // Funções para o modal
        function openCreateEventModal() {
            const createEventModal = document.getElementById('createEventModal');
            createEventModal.style.display = 'block';
            loadFriendsForSelection();
        }

        function closeModal() {
            document.getElementById('createEventModal').style.display = 'none';
        }

        // Função para criar novo evento
        async function handleCreateEvent(event) {
            event.preventDefault();
            
            try {
                const selectedFriends = Array.from(document.querySelectorAll('input[name="selectedFriends"]:checked'))
                    .map(input => input.value);

                console.log('Amigos selecionados:', selectedFriends);

                if (selectedFriends.length < 2) {
                    alert('Selecione pelo menos 2 amigos para criar o amigo oculto');
                    return;
                }

                const name = document.getElementById('eventName').value;
                const date = document.getElementById('eventDate').value;
                const budget = parseFloat(document.getElementById('eventBudget').value);

                const eventData = {
                    name,
                    date,
                    budget,
                    invitedFriends: selectedFriends
                };

                console.log('Dados sendo enviados:', eventData);

                const response = await fetch(`${API_URL}/secret-santa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(eventData)
                });

                const data = await response.json();
                console.log('Resposta do servidor:', data);

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao criar evento');
                }

                closeModal();
                loadEvents();
                document.getElementById('createEventForm').reset();
                alert('Evento criado com sucesso! Os convites foram enviados para os amigos selecionados.');
            } catch (error) {
                console.error('Erro ao criar evento:', error);
                alert(error.message);
            }
        }

        // Adicione também a função para carregar os eventos
        async function loadEvents() {
            try {
                const response = await fetch(`${API_URL}/secret-santa`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar eventos');

                const events = await response.json();
                const userData = JSON.parse(localStorage.getItem('userData'));
                console.log('Email do usuário atual:', userData?.email);
                console.log('Eventos:', events);

                const eventsList = document.getElementById('events-list');

                eventsList.innerHTML = events.map(event => `
                    <div class="event-item">
                        <div class="event-header">
                            <h3>${event.name}</h3>
                            ${event.organizerId === userData.id ? `
                                <button onclick="deleteEvent('${event.id}')" class="delete-btn" title="Excluir evento">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        <p>Data: ${new Date(event.date).toLocaleDateString()}</p>
                        <p>Valor Máximo: R$ ${Number(event.budget).toFixed(2)}</p>
                        <p>Participantes: ${event.participants.length}</p>
                        <div class="event-actions">
                            <button onclick="showEventDetailsModal('${event.id}')" class="details-btn">
                                Ver Detalhes
                            </button>
                            ${event.participants.length < 3 ? `
                                <p class="warning-text">É necessário pelo menos 3 participantes para realizar o sorteio</p>
                                <button onclick="showInviteModal('${event.id}')" class="invite-btn">
                                    Convidar Participantes
                                </button>
                            ` : event.participants.some(p => p.targetUserId !== null) ? `
                                <button onclick="showEventDetails('${event.id}')" class="details-btn">
                                    Ver Amigo Sorteado
                                </button>
                            ` : event.organizerId === userData.id ? `
                                <button onclick="performDraw('${event.id}')" class="draw-btn">
                                    Realizar Sorteio
                                </button>
                            ` : `
                                <p class="warning-text">Aguardando o administrador realizar o sorteio</p>
                            `}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar eventos');
            }
        }

        // Adicione esta função para facilitar adicionar amigos
        function showAddFriendFromEvent() {
            closeModal(); // Fecha o modal de criar evento
            openFriendsListModal(); // Abre o modal de amigos
        }

        // Fecha o modal se clicar fora dele
        window.onclick = function(event) {
            const createEventModal = document.getElementById('createEventModal');
            const addFriendModal = document.getElementById('addFriendModal');
            const friendsListModal = document.getElementById('friendsListModal');
            
            if (event.target === createEventModal) {
                closeModal();
            } else if (event.target === addFriendModal) {
                closeAddFriendModal();
            } else if (event.target === friendsListModal) {
                closeFriendsListModal();
            }
        }

        // Funções para gerenciar notificações
        async function loadFriendRequests() {
            try {
                const response = await fetch(`${API_URL}/friends/pending`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar solicitações');

                const requests = await response.json();
                console.log('Solicitações de amizade:', requests);

                // Carrega os convites de amigo oculto
                const notificationsResponse = await fetch(`${API_URL}/notifications/event-invites`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!notificationsResponse.ok) {
                    throw new Error('Erro ao carregar convites de amigo oculto');
                }

                const eventInvites = await notificationsResponse.json();
                console.log('Convites de amigo oculto:', eventInvites);

                const requestsList = document.getElementById('friend-requests-list');

                if (requests.length === 0 && eventInvites.length === 0) {
                    requestsList.innerHTML = '<p>Nenhuma solicitação pendente.</p>';
                    return;
                }

                requestsList.innerHTML = `
                    ${requests.map(request => `
                        <div class="friend-request-item">
                            <div class="request-info">
                                <strong>${request.sender.name}</strong>
                                <div>${request.sender.email}</div>
                            </div>
                            <div class="request-actions">
                                <button onclick="handleFriendRequest('${request.id}', true)" class="accept-btn">
                                    <i class="fas fa-check"></i> Aceitar
                                </button>
                                <button onclick="handleFriendRequest('${request.id}', false)" class="reject-btn">
                                    <i class="fas fa-times"></i> Recusar
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    ${eventInvites.map(invite => `
                        <div class="friend-request-item event-invite">
                            <div class="request-info">
                                <strong>Convite para Amigo Oculto</strong>
                                <div>De: ${invite.sender.name}</div>
                                <div>Evento: ${invite.secretSanta.name}</div>
                                <div>Data: ${new Date(invite.secretSanta.date).toLocaleDateString()}</div>
                                <div>Valor: R$ ${Number(invite.secretSanta.budget).toFixed(2)}</div>
                            </div>
                            <div class="request-actions">
                                <button onclick="handleEventInvite('${invite.secretSantaId}', true)" class="accept-btn">
                                    <i class="fas fa-check"></i> Aceitar
                                </button>
                                <button onclick="handleEventInvite('${invite.secretSantaId}', false)" class="reject-btn">
                                    <i class="fas fa-times"></i> Recusar
                                </button>
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Erro ao carregar solicitações/convites:', error);
                document.getElementById('friend-requests-list').innerHTML = 
                    '<p>Erro ao carregar solicitações. Tente novamente mais tarde.</p>';
            }
        }

        // Atualiza a inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (!userData || !userData.id || !userData.email || !userData.name) {
                    throw new Error('Dados do usuário inválidos ou incompletos');
                }

                console.log('=== DADOS DO USUÁRIO CARREGADOS ===', {
                    id: userData.id,
                    email: userData.email,
                    name: userData.name
                });

                loadUserData();
                loadEvents();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                window.location.href = '/';
            }
        });

        // Atualize o intervalo
        setInterval(loadFriendRequests, 60000);

        // Funções para gerenciar amigos
        async function loadFriends() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (!userData?.id || !userData?.email) {
                    throw new Error('Usuário não autenticado ou dados incompletos');
                }

                const response = await fetch(`${API_URL}/friends`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar amigos');

                const friends = await response.json();
                const friendsList = document.getElementById('friends-list');

                friendsList.innerHTML = friends.map(friend => `
                    <div class="friend-item">
                        <div>
                            <strong>${friend.name}</strong>
                            <div>${friend.email}</div>
                        </div>
                        <button onclick="inviteToEvent('${friend.id}')">Convidar</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('friends-list').innerHTML = '<p>Erro ao carregar amigos.</p>';
            }
        }

        function showAddFriendModal() {
            document.getElementById('addFriendModal').style.display = 'block';
        }

        function closeAddFriendModal() {
            document.getElementById('addFriendModal').style.display = 'none';
        }

        async function handleAddFriend(event) {
            event.preventDefault();
            const email = document.getElementById('friendEmail').value;

            console.log('Enviando solicitação para:', email);
            console.log('Token:', localStorage.getItem('token'));

            try {
                const response = await fetch(`${API_URL}/friends/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ email })
                });

                console.log('Status da resposta:', response.status);
                const data = await response.json();
                console.log('Resposta:', data);

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao enviar solicitação');
                }

                closeAddFriendModal();
                document.getElementById('addFriendForm').reset();
                alert('Solicitação de amizade enviada!');
                loadFriends(); // Recarrega a lista de amigos
            } catch (error) {
                console.error('Erro detalhado:', error);
                alert(error.message);
            }
        }

        // Adicione estas chamadas à inicialização
        loadFriendRequests();
        loadFriends();

        // Atualiza as notificações a cada minuto
        setInterval(loadFriendRequests, 60000);

        // Adicione a função para lidar com as respostas às solicitações de amizade
        async function handleFriendRequest(friendshipId, accept) {
            try {
                console.log('Respondendo à solicitação:', { friendshipId, accept });
                
                const response = await fetch(`${API_URL}/friends/request/${friendshipId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ accept })
                });

                const data = await response.json();
                console.log('Resposta:', data);

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao responder solicitação');
                }

                // Recarrega as notificações e a lista de amigos
                await Promise.all([loadFriendRequests(), loadFriends()]);
                alert(`Solicitação de amizade ${accept ? 'aceita' : 'recusada'} com sucesso!`);
            } catch (error) {
                console.error('Erro ao responder solicitação:', error);
                alert(error.message);
            }
        }

        // Adicione estas novas funções
        function openFriendsListModal() {
            document.getElementById('friendsListModal').style.display = 'block';
            loadFriendsList();
        }

        function closeFriendsListModal() {
            document.getElementById('friendsListModal').style.display = 'none';
        }

        async function loadFriendsList() {
            try {
                const response = await fetch(`${API_URL}/friends`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar amigos');

                const friends = await response.json();
                const friendsList = document.getElementById('friendsListComplete');

                if (friends.length === 0) {
                    friendsList.innerHTML = '<p>Você ainda não tem amigos adicionados.</p>';
                    return;
                }

                friendsList.innerHTML = friends.map(friend => `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-email">${friend.email}</div>
                        </div>
                        <button onclick="inviteToEvent('${friend.id}')" class="invite-btn">
                            Convidar para Amigo Oculto
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar lista de amigos');
            }
        }

        // Adicione a função para deletar notificação
        async function deleteNotification(notificationId) {
            try {
                const response = await fetch(`${API_URL}/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erro ao deletar notificação');
                }

                await loadNotifications(); // Recarrega as notificações
            } catch (error) {
                console.error('Erro ao deletar notificação:', error);
                alert(error.message);
            }
        }

        // Adicione a função para convidar amigos
        async function inviteToEvent(friendId, eventId) {
            try {
                const response = await fetch(`${API_URL}/secret-santa/${eventId}/invite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ invitedUserId: friendId })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao enviar convite');
                }

                alert('Convite enviado com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        }

        // Adicione esta função para carregar amigos no modal de criação
        async function loadFriendsForSelection() {
            try {
                const response = await fetch(`${API_URL}/friends`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar amigos');

                const friends = await response.json();
                console.log('Amigos disponíveis:', friends);
                const friendsSelection = document.getElementById('friendsSelection');

                friendsSelection.innerHTML = friends.map(friend => `
                    <div class="friend-select-item">
                        <label for="friend_${friend.id}" class="friend-select-label">
                            <input type="checkbox" name="selectedFriends" value="${friend.id}" id="friend_${friend.id}" class="friend-checkbox">
                            <div class="friend-info">
                                <strong>${friend.name}</strong>
                                <div class="friend-email">${friend.email}</div>
                            </div>
                        </label>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar amigos:', error);
                alert('Erro ao carregar lista de amigos');
            }
        }

        async function handleEventInvite(eventId, accept) {
            try {
                const response = await fetch(`${API_URL}/secret-santa/${eventId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ accept })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erro ao responder ao convite');
                }

                const data = await response.json();
                alert(data.message);
                
                // Recarrega as notificações e eventos
                await Promise.all([
                    loadFriendRequests(),
                    loadEvents()
                ]);
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        }

        // Adicione estas funções
        async function showEventDetails(eventId) {
            try {
                const response = await fetch(`${API_URL}/secret-santa/${eventId}/target`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar detalhes');

                const data = await response.json();
                const modal = document.getElementById('drawnFriendModal');
                const content = document.getElementById('drawnFriendContent');
                
                content.innerHTML = `
                    <div class="friend-info">
                        <p><strong>Você tirou:</strong></p>
                        <h2>${data.target.name}</h2>
                        <p><strong>Email:</strong> ${data.target.email}</p>
                    </div>
                    <div class="event-info">
                        <p><strong>Data do Evento:</strong> ${new Date(data.event.date).toLocaleDateString()}</p>
                        <p><strong>Valor Máximo:</strong> R$ ${Number(data.event.budget).toFixed(2)}</p>
                    </div>
                `;
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        }

        async function performDraw(eventId) {
            try {
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (!userData || !userData.id) {
                    throw new Error('Usuário não autenticado');
                }

                console.log('=== DEBUG SORTEIO ===', {
                    eventId,
                    userId: userData.id,
                    token: localStorage.getItem('token')?.substring(0, 10) + '...'
                });

                if (!confirm('Tem certeza que deseja realizar o sorteio? Esta ação não pode ser desfeita.')) {
                    return;
                }

                const response = await fetch(`${API_URL}/secret-santa/${eventId}/draw`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                console.log('=== RESPOSTA DO SORTEIO ===', data);

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao realizar sorteio');
                }

                alert('Sorteio realizado com sucesso!');
                loadEvents();
            } catch (error) {
                console.error('Erro ao realizar sorteio:', error);
                alert(error.message);
            }
        }

        let currentEventId = null; // Variável para armazenar o ID do evento atual

        async function showInviteModal(eventId) {
            currentEventId = eventId;
            const modal = document.getElementById('inviteModal');
            modal.style.display = 'block';
            await loadFriendsForInvite(eventId);
        }

        function closeInviteModal() {
            const modal = document.getElementById('inviteModal');
            modal.style.display = 'none';
            currentEventId = null;
        }

        async function loadFriendsForInvite(eventId) {
            try {
                // Busca a lista de amigos
                const friendsResponse = await fetch(`${API_URL}/friends`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                // Busca os participantes atuais do evento
                const eventResponse = await fetch(`${API_URL}/secret-santa/${eventId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!friendsResponse.ok || !eventResponse.ok) {
                    throw new Error('Erro ao carregar dados');
                }

                const friends = await friendsResponse.json();
                const event = await eventResponse.json();

                // Filtra amigos que já são participantes
                const participantIds = event.participants.map(p => p.userId);
                const availableFriends = friends.filter(friend => !participantIds.includes(friend.id));

                const friendsList = document.getElementById('inviteFriendsSelection');
                
                if (availableFriends.length === 0) {
                    friendsList.innerHTML = '<p class="no-friends-message">Todos os seus amigos já foram convidados para este evento.</p>';
                    return;
                }

                friendsList.innerHTML = availableFriends.map(friend => `
                    <div class="friend-select-item">
                        <label for="invite_friend_${friend.id}">
                            <input type="checkbox" id="invite_friend_${friend.id}" value="${friend.id}">
                            <span class="friend-info">
                                <strong>${friend.name}</strong>
                                <div class="friend-email">${friend.email}</div>
                            </span>
                        </label>
                    </div>
                `).join('');

                // Adiciona eventos de hover nos itens
                document.querySelectorAll('.friend-select-item').forEach(item => {
                    item.addEventListener('mouseover', () => {
                        item.style.backgroundColor = '#f8f9fa';
                    });
                    item.addEventListener('mouseout', () => {
                        item.style.backgroundColor = '';
                    });
                });
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar amigos para convite');
            }
        }

        async function sendInvites() {
            try {
                const selectedFriends = Array.from(document.querySelectorAll('#inviteFriendsSelection input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedFriends.length === 0) {
                    alert('Selecione pelo menos um amigo para convidar');
                    return;
                }

                const promises = selectedFriends.map(friendId =>
                    fetch(`${API_URL}/secret-santa/${currentEventId}/invite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ invitedUserId: friendId })
                    })
                );

                await Promise.all(promises);
                alert('Convites enviados com sucesso!');
                closeInviteModal();
                loadEvents(); // Recarrega a lista de eventos
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar convites');
            }
        }

        async function showEventDetailsModal(eventId) {
            try {
                const response = await fetch(`${API_URL}/secret-santa/${eventId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar detalhes do evento');

                const event = await response.json();
                const modal = document.getElementById('eventDetailsModal');
                const content = document.getElementById('eventDetailsContent');

                content.innerHTML = `
                    <div class="event-info">
                        <h3>${event.name}</h3>
                        <p><strong>Data:</strong> ${new Date(event.date).toLocaleDateString()}</p>
                        <p><strong>Valor Máximo:</strong> R$ ${Number(event.budget).toFixed(2)}</p>
                        <p><strong>Organizador:</strong> ${event.organizer.name}</p>
                        <p><strong>Total de Participantes:</strong> ${event.participants.length}</p>
                    </div>
                    <h3>Participantes</h3>
                    <div class="event-details-grid">
                        ${event.participants.map(p => `
                            <div class="participant-card">
                                <h4>${p.user.name}</h4>
                                <div class="participant-info">
                                    <p>${p.user.email}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                modal.style.display = 'block';
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        }

        function closeEventDetailsModal() {
            const modal = document.getElementById('eventDetailsModal');
            modal.style.display = 'none';
        }

        function closeDrawnFriendModal() {
            const modal = document.getElementById('drawnFriendModal');
            modal.style.display = 'none';
        }

        async function deleteEvent(eventId) {
            try {
                if (!confirm('Tem certeza que deseja excluir este evento? Esta ação não pode ser desfeita.')) {
                    return;
                }

                const response = await fetch(`${API_URL}/secret-santa/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao excluir evento');
                }

                alert('Evento excluído com sucesso!');
                loadEvents(); // Recarrega a lista de eventos
            } catch (error) {
                console.error('Erro ao excluir evento:', error);
                alert(error.message);
            }
        }

        // Adiciona verificação inicial
        document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (!userData || !userData.id) {
                console.error('Dados do usuário inválidos');
                window.location.href = '/';
                return;
            }
            loadUserData();
            loadEvents();
        });

        function clearAllData() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Você precisará fazer login novamente.')) {
                localStorage.clear();
                window.location.href = '/';
            }
        }
    </script>
</body>
</html> 